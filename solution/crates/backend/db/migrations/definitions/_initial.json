{"schemas":"DEFINE TABLE OVERWRITE advertiser \n    SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE name ON advertiser \n    TYPE string;\nDEFINE TABLE OVERWRITE campaign SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE advertiser_id ON campaign\n    TYPE record<advertiser>;\nDEFINE FIELD OVERWRITE impressions_limit ON campaign\n    TYPE number\n    ASSERT $value > 0;\nDEFINE FIELD OVERWRITE clicks_limit ON campaign\n    TYPE number\n    ASSERT $value >= 0;\nDEFINE FIELD OVERWRITE cost_per_impression ON campaign\n    TYPE float\n    ASSERT $value > 0f;\nDEFINE FIELD OVERWRITE cost_per_click ON campaign\n    TYPE float\n    ASSERT $value > 0f;\nDEFINE FIELD OVERWRITE ad_title ON campaign\n    TYPE string;\nDEFINE FIELD OVERWRITE ad_text ON campaign\n    TYPE string;\nDEFINE FIELD OVERWRITE start_date ON campaign\n    TYPE number;\nDEFINE FIELD OVERWRITE end_date ON campaign\n    TYPE number;\nDEFINE FIELD OVERWRITE targeting ON campaign\n    TYPE {\n        gender: option<\"MALE\" | \"FEMALE\" | \"ALL\">,\n        age_from: option<number>,\n        age_to: option<number>,\n        location: option<string>\n    };\nDEFINE FIELD OVERWRITE is_active ON campaign\n    TYPE bool\n    VALUE fn::update_campaign_active($this.id);\nDEFINE TABLE OVERWRITE client SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE login ON client \n    TYPE string;\nDEFINE FIELD OVERWRITE age ON client \n    TYPE number\n    ASSERT $value >= 0;\nDEFINE FIELD OVERWRITE location ON client \n    TYPE string;\nDEFINE FIELD OVERWRITE gender ON client \n    TYPE \"MALE\" | \"FEMALE\";\nDEFINE TABLE OVERWRITE interacted_with\n    SCHEMAFULL\n    TYPE RELATION FROM client TO campaign ENFORCED;\n\nDEFINE FIELD OVERWRITE impressed ON interacted_with\n    TYPE number\n    VALUE IF type::is::number($before) {\n        $before\n    } ELSE { fn::current_day() };\nDEFINE FIELD OVERWRITE clicked ON interacted_with\n    TYPE option<number>\n    VALUE IF $value != none {\n        fn::current_day()\n    };\nDEFINE TABLE OVERWRITE scored \n    SCHEMAFULL\n    TYPE RELATION FROM advertiser TO client ENFORCED;\n\nDEFINE FIELD OVERWRITE score ON scored\n    TYPE number\n    ASSERT $value >= 0;\nDEFINE TABLE OVERWRITE script_migration SCHEMAFULL\n    PERMISSIONS\n        FOR select FULL\n        FOR create, update, delete NONE;\n\nDEFINE FIELD OVERWRITE script_name ON script_migration TYPE string;\nDEFINE FIELD OVERWRITE executed_at ON script_migration TYPE datetime VALUE time::now() READONLY;\nDEFINE TABLE OVERWRITE stats_advertiser SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE advertiser_id ON stats_advertiser\n    TYPE record<advertiser>;\nDEFINE FIELD OVERWRITE current ON stats_advertiser\n    TYPE {\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }\n    VALUE IF $after.id == NONE { fn::default_stats() }\n        ELSE { fn::update_stats($after.id) };\nDEFINE FIELD OVERWRITE total ON stats_advertiser\n    TYPE {\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }\n    VALUE IF $after.id == NONE { fn::default_stats() }\n        ELSE { fn::update_stats($after.id) };\nDEFINE FIELD OVERWRITE daily ON stats_advertiser\n    TYPE array<{\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }>;\nDEFINE TABLE OVERWRITE stats_campaign SCHEMAFULL;\n\nDEFINE FIELD OVERWRITE campaign_id ON stats_campaign\n    TYPE record<campaign>;\nDEFINE FIELD OVERWRITE current ON stats_campaign\n    TYPE {\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }\n    VALUE IF $after.id == NONE { fn::default_stats() }\n        ELSE { fn::update_stats($after.id) };\nDEFINE FIELD OVERWRITE total ON stats_campaign\n    TYPE {\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }\n    VALUE IF $after.id == NONE { fn::default_stats() }\n        ELSE { fn::update_stats($after.id) };\nDEFINE FIELD OVERWRITE daily ON stats_campaign\n    TYPE array<{\n        impressions_count: number,\n        clicks_count: number,\n        conversion: float,\n        spent_impressions: float,\n        spent_clicks: float,\n        spent_total: float,\n    }>;\nDEFINE TABLE OVERWRITE system SCHEMALESS;","events":"DEFINE EVENT OVERWRITE advertiser_created ON TABLE advertiser WHEN $event == \"CREATE\" THEN {\n    fn::create_stats($this.id);\n};\nDEFINE EVENT OVERWRITE campaign_created ON TABLE campaign WHEN $event == \"CREATE\" THEN {\n    fn::create_stats($this.id);\n};\nDEFINE EVENT OVERWRITE clicked ON TABLE interacted_with WHEN $event == \"UPDATE\" THEN {\n    LET $clicks_count_delta: number = 1;\n    LET $spent_clicks_delta = $value.out.cost_per_click;\n    UPDATE type::thing(\"stats_campaign\", $value.out.id()), type::thing(\"stats_advertiser\", $value.out.advertiser_id.id()) \n        SET \n            current.clicks_count += $clicks_count_delta,\n            current.spent_clicks += $spent_clicks_delta,\n            total.clicks_count += $clicks_count_delta,\n            total.spent_clicks += $spent_clicks_delta;\n};\nDEFINE EVENT OVERWRITE day_changed ON TABLE time WHEN $event == \"UPDATE\" THEN {\n    FOR $stats IN SELECT id, campaign_id, daily, current FROM stats_campaign {\n        fn::update_campaign_active($stats.campaign_id);\n\t\tUPDATE ONLY $stats.id\n\t\t\tMERGE {\n\t\t\t\tdaily: IF $stats.campaign_id.is_active {\n                    $stats.daily.append($stats.current)\n                } ELSE {\n                    $stats.daily\n                },\n\t\t\t\tcurrent: fn::default_stats(),\n\t\t\t};\n\t};\n    FOR $stats IN SELECT id, daily, current FROM stats_advertiser {\n\t\tUPDATE ONLY $stats.id\n\t\t\tMERGE {\n\t\t\t\tdaily: $stats.daily.append($stats.current),\n\t\t\t\tcurrent: fn::default_stats(),\n\t\t\t};\n\t};\n};\nDEFINE EVENT OVERWRITE impressed ON TABLE interacted_with WHEN $event == \"CREATE\" THEN {\n    LET $impressions_count_delta: number = 1;\n    LET $spent_impressions_delta = $value.out.cost_per_impression;\n    fn::update_campaign_active($value.out);\n    UPDATE type::thing(\"stats_campaign\", $value.out.id()), type::thing(\"stats_advertiser\", $value.out.advertiser_id.id()) \n        SET \n            current.impressions_count += $impressions_count_delta,\n            current.spent_impressions += $spent_impressions_delta,\n            total.impressions_count += $impressions_count_delta,\n            total.spent_impressions += $spent_impressions_delta;\n};"}