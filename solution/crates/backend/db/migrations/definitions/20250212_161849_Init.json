{"schemas":"--- original\n+++ modified\n@@ -89,8 +89,7 @@\n         spent_clicks: float,\n         spent_total: float,\n     }\n-    VALUE IF $after.id == NONE { fn::default_stats() }\n-        ELSE { fn::update_stats($after.id) };\n+    VALUE fn::update_stats($after);\n DEFINE FIELD OVERWRITE total ON stats_advertiser\n     TYPE {\n         impressions_count: number,\n@@ -100,8 +99,7 @@\n         spent_clicks: float,\n         spent_total: float,\n     }\n-    VALUE IF $after.id == NONE { fn::default_stats() }\n-        ELSE { fn::update_stats($after.id) };\n+    VALUE fn::update_stats($after);\n DEFINE FIELD OVERWRITE daily ON stats_advertiser\n     TYPE array<{\n         impressions_count: number,\n@@ -124,8 +122,8 @@\n         spent_clicks: float,\n         spent_total: float,\n     }\n-    VALUE IF $after.id == NONE { fn::default_stats() }\n-        ELSE { fn::update_stats($after.id) };\n+    VALUE IF $this.id == NONE { fn::default_stats() }\n+        ELSE { fn::update_stats($this.current) };\n DEFINE FIELD OVERWRITE total ON stats_campaign\n     TYPE {\n         impressions_count: number,\n@@ -135,8 +133,8 @@\n         spent_clicks: float,\n         spent_total: float,\n     }\n-    VALUE IF $after.id == NONE { fn::default_stats() }\n-        ELSE { fn::update_stats($after.id) };\n+    VALUE IF $this.id == NONE { fn::default_stats() }\n+        ELSE { fn::update_stats($this.total) };\n DEFINE FIELD OVERWRITE daily ON stats_campaign\n     TYPE array<{\n         impressions_count: number,\n","events":"--- original\n+++ modified\n@@ -2,8 +2,11 @@\n     fn::create_stats($this.id);\n };\n DEFINE EVENT OVERWRITE campaign_created ON TABLE campaign WHEN $event == \"CREATE\" THEN {\n-    fn::create_stats($this.id);\n+    fn::create_stats($after.id);\n };\n+DEFINE EVENT OVERWRITE campaign_deleted ON TABLE campaign WHEN $event == \"DELETE\" THEN {\n+    DELETE fn::stats_id_from_obj_id($this.id);\n+};\n DEFINE EVENT OVERWRITE clicked ON TABLE interacted_with WHEN $event == \"UPDATE\" THEN {\n     LET $clicks_count_delta: number = 1;\n     LET $spent_clicks_delta = $value.out.cost_per_click;\n@@ -14,9 +17,12 @@\n             total.clicks_count += $clicks_count_delta,\n             total.spent_clicks += $spent_clicks_delta;\n };\n-DEFINE EVENT OVERWRITE day_changed ON TABLE time WHEN $event == \"UPDATE\" THEN {\n+DEFINE EVENT OVERWRITE day_changed ON TABLE system WHEN $value.id.id() == \"time\" && $event == \"UPDATE\" THEN {\n     FOR $stats IN SELECT id, campaign_id, daily, current FROM stats_campaign {\n-        fn::update_campaign_active($stats.campaign_id);\n+        UPDATE ONLY $stats.campaign_id\n+\t\t\tMERGE {\n+\t\t\t\tis_active: true\n+\t\t\t};\n \t\tUPDATE ONLY $stats.id\n \t\t\tMERGE {\n \t\t\t\tdaily: IF $stats.campaign_id.is_active {\n@@ -38,7 +44,6 @@\n DEFINE EVENT OVERWRITE impressed ON TABLE interacted_with WHEN $event == \"CREATE\" THEN {\n     LET $impressions_count_delta: number = 1;\n     LET $spent_impressions_delta = $value.out.cost_per_impression;\n-    fn::update_campaign_active($value.out);\n     UPDATE type::thing(\"stats_campaign\", $value.out.id()), type::thing(\"stats_advertiser\", $value.out.advertiser_id.id()) \n         SET \n             current.impressions_count += $impressions_count_delta,\n@@ -45,4 +50,16 @@\n             current.spent_impressions += $spent_impressions_delta,\n             total.impressions_count += $impressions_count_delta,\n             total.spent_impressions += $spent_impressions_delta;\n+    fn::update_campaign_active($value.out);\n+};\n+DEFINE EVENT OVERWRITE scored ON TABLE scored WHEN $event âˆˆ [\"CREATE\", \"UPDATE\"] THEN {\n+    LET $scores = fn::ml_scores();\n+    LET $min: float = math::min($scores.min, $value);\n+    LET $max: float = math::max($scores.max, $value);\n+\n+    UPDATE ONLY system:ml_score\n+        SET \n+            min = $min,\n+            max = $max,\n+            delta = 1dec / ($max - $min);\n };\n\\ No newline at end of file\n"}